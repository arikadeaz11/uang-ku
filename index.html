<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinDeazVindi - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .bg-vindi { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .loading-shimmer { animation: shimmer 1.5s infinite linear; background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%); background-size: 800px 104px; }
        @keyframes shimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen pb-24">
    <div class="bg-vindi p-8 rounded-b-[45px] text-white text-center shadow-2xl shadow-indigo-200">
        <div class="flex justify-between items-center mb-6">
            <span class="text-[10px] bg-white/20 px-3 py-1 rounded-full font-bold uppercase tracking-widest border border-white/30">Gemini AI Active</span>
            <button onclick="resetData()" class="text-[10px] text-indigo-100 hover:text-white uppercase font-bold">Reset</button>
        </div>
        <p class="text-indigo-100 text-xs font-bold uppercase tracking-wider mb-1">Saldo Tersedia</p>
        <h1 id="balance" class="text-4xl font-black mb-6">Rp 0</h1>
        
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white/15 backdrop-blur-lg p-3 rounded-2xl border border-white/20 text-left">
                <p class="text-[9px] uppercase font-bold text-indigo-100 mb-1">Pemasukan</p>
                <p id="total-income" class="text-sm font-black text-emerald-300">Rp 0</p>
            </div>
            <div class="bg-white/15 backdrop-blur-lg p-3 rounded-2xl border border-white/20 text-left">
                <p class="text-[9px] uppercase font-bold text-indigo-100 mb-1">Pengeluaran</p>
                <p id="total-expense" class="text-sm font-black text-rose-300">Rp 0</p>
            </div>
        </div>
    </div>

    <div class="px-6 -mt-8">
        <div class="bg-white p-6 rounded-[32px] shadow-xl border border-gray-100">
            <div class="space-y-4">
                <input type="text" id="desc-input" placeholder="Apa transaksinya? (cth: beli soto ayam)" 
                       class="w-full p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 font-medium text-gray-700 transition-all border-none">
                <div class="flex gap-3">
                    <input type="text" id="amount-input" placeholder="Harga (cth: 15rb)" 
                           class="flex-1 p-4 bg-gray-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 font-bold text-gray-700 transition-all border-none">
                    <button id="btn-save" onclick="addTransaction()" 
                            class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-indigo-700 active:scale-90 transition-all shadow-lg shadow-indigo-100">
                        CATAT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="px-6 mt-10">
        <h3 class="font-black text-gray-800 text-lg mb-5 flex items-center gap-2">
            Riwayat <span class="bg-indigo-100 text-indigo-600 text-[10px] px-2 py-1 rounded-lg">Real-time</span>
        </h3>
        <div id="transaction-list" class="space-y-4">
            </div>
    </div>
</div>

<script>
    // URL Web App dari Google Apps Script kamu
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwCMl7463LmrJfh5NMSHSp9Ri4ECeUOuEQZz5H4iac9ZuL21RfwNlsbFYAqL1oq85s/exec";

    let transactions = JSON.parse(localStorage.getItem('vindi_ai_db')) || [];

    function formatIDR(num) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
    }

    async function addTransaction() {
        const dInput = document.getElementById('desc-input');
        const aInput = document.getElementById('amount-input');
        const btn = document.getElementById('btn-save');
        
        if (!dInput.value || !aInput.value) return;

        // 1. Proses Angka
        let amtTxt = aInput.value.toLowerCase().replace(/[^0-9a-z]/g, '');
        let amount = parseInt(amtTxt.replace(/[^0-9]/g, '')) || 0;
        if (amtTxt.includes('jt')) amount *= 1000000;
        else if (amtTxt.includes('rb') || amtTxt.includes('k')) amount *= 1000;

        const originalDesc = dInput.value;
        
        // UI Loading
        btn.disabled = true;
        btn.innerText = "...";
        dInput.value = "ðŸ¤– Gemini sedang menganalisis...";
        dInput.disabled = true;

        try {
            // 2. Kirim ke Backend (GAS + Gemini)
            const response = await fetch(SHEETS_URL, {
                method: 'POST',
                body: JSON.stringify({ description: originalDesc, amount: amount })
            });
            
            const ai = await response.json();

            // 3. Gabungkan Data
            const newTx = {
                id: Date.now(),
                desc: originalDesc,
                amount: amount,
                category: ai.category,
                type: ai.type,
                icon: ai.icon
            };

            transactions.unshift(newTx);
            localStorage.setItem('vindi_ai_db', JSON.stringify(transactions));
            render();

        } catch (err) {
            alert("Koneksi gagal, pastikan Apps Script sudah di-deploy dengan benar.");
        }

        // Reset UI
        dInput.disabled = false;
        dInput.value = '';
        aInput.value = '';
        btn.disabled = false;
        btn.innerText = "CATAT";
    }

    function deleteTx(id) {
        if(confirm("Hapus dari daftar HP?")) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('vindi_ai_db', JSON.stringify(transactions));
            render();
        }
    }

    function resetData() {
        if(confirm("Hapus semua riwayat lokal?")) {
            transactions = [];
            localStorage.removeItem('vindi_ai_db');
            render();
        }
    }

    function render() {
        const list = document.getElementById('transaction-list');
        list.innerHTML = '';
        let totalInc = 0, totalExp = 0;

        transactions.forEach(tx => {
            if(tx.type === 'income') totalInc += tx.amount;
            else totalExp += tx.amount;

            list.innerHTML += `
                <div class="bg-white p-4 rounded-[24px] flex items-center justify-between shadow-sm border border-gray-50">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 flex items-center justify-center text-2xl bg-gray-50 rounded-2xl shadow-inner">
                            ${tx.icon}
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 text-sm leading-tight">${tx.desc}</p>
                            <p class="text-[9px] text-indigo-500 font-black uppercase tracking-widest mt-1">${tx.category}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-sm ${tx.type === 'income' ? 'text-emerald-600' : 'text-gray-900'}">
                            ${tx.type === 'income' ? '+' : '-'}${formatIDR(tx.amount)}
                        </p>
                        <button onclick="deleteTx(${tx.id})" class="text-[9px] font-bold text-gray-300 hover:text-rose-500 uppercase">Hapus</button>
                    </div>
                </div>
            `;
        });

        if(transactions.length === 0) {
            list.innerHTML = '<div class="text-center py-10 text-gray-400 text-xs italic">Belum ada aktivitas hari ini.</div>';
        }

        document.getElementById('balance').innerText = formatIDR(totalInc - totalExp);
        document.getElementById('total-income').innerText = formatIDR(totalInc);
        document.getElementById('total-expense').innerText = formatIDR(totalExp);
    }

    render();
</script>

</body>
</html>
